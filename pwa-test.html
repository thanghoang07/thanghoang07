<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Test</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#9333ea">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #f9fafb;
        }
        .status {
            padding: 16px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 500;
        }
        .success { background: #d1fae5; color: #065f46; }
        .error { background: #fee2e2; color: #991b1b; }
        .info { background: #dbeafe; color: #1e40af; }
        button {
            padding: 12px 24px;
            background: #9333ea;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #7c3aed;
        }
        #install-btn {
            background: #10b981;
        }
    </style>
</head>
<body>
    <h1>🚀 PWA Test Page</h1>
    
    <div id="status-container">
        <div class="status info">Đang kiểm tra PWA features...</div>
    </div>
    
    <div id="controls">
        <button id="install-btn" style="display: none;">📱 Install App</button>
        <button id="clear-cache">🗑️ Clear Cache</button>
        <button id="test-offline">📡 Test Offline Mode</button>
        <button id="check-updates">🔄 Check Updates</button>
    </div>
    
    <div id="info">
        <h3>📊 PWA Information</h3>
        <ul id="pwa-info"></ul>
    </div>

    <script>
        let deferredPrompt;
        const statusContainer = document.getElementById('status-container');
        const installBtn = document.getElementById('install-btn');
        const pwaInfo = document.getElementById('pwa-info');

        function addStatus(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.textContent = message;
            statusContainer.appendChild(div);
        }

        function updateInfo() {
            const info = [
                `🌐 Online: ${navigator.onLine ? 'Yes' : 'No'}`,
                `📱 Service Worker: ${navigator.serviceWorker ? 'Supported' : 'Not supported'}`,
                `🔔 Notifications: ${window.Notification ? Notification.permission : 'Not supported'}`,
                `📦 Cache API: ${window.caches ? 'Supported' : 'Not supported'}`,
                `🔄 Background Sync: ${window.navigator.serviceWorker && 'sync' in window.ServiceWorkerRegistration.prototype ? 'Supported' : 'Not supported'}`,
                `💾 IndexedDB: ${window.indexedDB ? 'Supported' : 'Not supported'}`,
                `📲 Add to Home Screen: ${deferredPrompt ? 'Available' : 'Not available'}`
            ];
            
            pwaInfo.innerHTML = info.map(item => `<li>${item}</li>`).join('');
        }

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    addStatus('✅ Service Worker đăng ký thành công!', 'success');
                    
                    registration.addEventListener('updatefound', () => {
                        addStatus('🔄 Phiên bản mới có sẵn!', 'info');
                    });
                })
                .catch(error => {
                    addStatus('❌ Service Worker đăng ký thất bại: ' + error.message, 'error');
                });
        }

        // Install Prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBtn.style.display = 'inline-block';
            addStatus('📱 App có thể cài đặt!', 'success');
            updateInfo();
        });

        installBtn.addEventListener('click', async () => {
            if (!deferredPrompt) return;
            
            const result = await deferredPrompt.prompt();
            addStatus(`Install prompt result: ${result.outcome}`, result.outcome === 'accepted' ? 'success' : 'info');
            deferredPrompt = null;
            installBtn.style.display = 'none';
            updateInfo();
        });

        // App Installed
        window.addEventListener('appinstalled', () => {
            addStatus('🎉 App đã được cài đặt!', 'success');
            installBtn.style.display = 'none';
            updateInfo();
        });

        // Online/Offline Status
        window.addEventListener('online', () => {
            addStatus('🌐 Đã kết nối internet', 'success');
            updateInfo();
        });

        window.addEventListener('offline', () => {
            addStatus('📡 Mất kết nối internet', 'error');
            updateInfo();
        });

        // Controls
        document.getElementById('clear-cache').addEventListener('click', async () => {
            if ('caches' in window) {
                const cacheNames = await caches.keys();
                await Promise.all(cacheNames.map(name => caches.delete(name)));
                addStatus('🗑️ Cache đã được xóa', 'success');
            }
        });

        document.getElementById('test-offline').addEventListener('click', () => {
            // Simulate offline by making request to non-existent endpoint
            fetch('/offline-test')
                .then(() => addStatus('🌐 Vẫn còn online', 'info'))
                .catch(() => addStatus('📡 Offline mode hoạt động', 'success'));
        });

        document.getElementById('check-updates').addEventListener('click', () => {
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({ type: 'CHECK_UPDATE' });
                addStatus('🔄 Đang kiểm tra cập nhật...', 'info');
            }
        });

        // Initial update
        updateInfo();
        addStatus('✅ PWA Test page loaded successfully!', 'success');
    </script>
</body>
</html>